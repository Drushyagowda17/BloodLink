{% extends "base.html" %}

{% block title %}Record Blood Usage - BloodLink{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
        <div class="card shadow">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h3 class="mb-0">
                    <i class="fas fa-clipboard-list me-2"></i>
                    <span data-i18n="record_blood_usage">Record Blood Usage</span>
                </h3>
                <a href="{{ url_for('hospital_dashboard') }}" class="btn btn-light btn-sm">
                    <i class="fas fa-arrow-left me-1"></i>
                    <span data-i18n="back">Back</span>
                </a>
            </div>
            <div class="card-body p-5">
                <!-- Donor Information Display -->
                <div class="alert alert-info" role="alert">
                    <h6 class="alert-heading">
                        <i class="fas fa-user me-2"></i>
                        <span data-i18n="donor_details">Donor Details</span>
                    </h6>
                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <strong data-i18n="full_name">Name:</strong> {{ donor.name }}
                        </div>
                        <div class="col-md-6">
                            <strong data-i18n="blood_group">Blood Group:</strong> 
                            <span class="blood-group-badge">{{ donor.blood_group }}</span>
                        </div>
                        <div class="col-md-6">
                            <strong data-i18n="age">Age:</strong> {{ donor.age }} years
                        </div>
                        <div class="col-md-6">
                            <strong data-i18n="gender">Gender:</strong> {{ donor.gender }}
                        </div>
                        <div class="col-12">
                            <strong data-i18n="location">Location:</strong> {{ donor.city }}, {{ donor.state }} - {{ donor.pincode }}
                        </div>
                        <div class="col-md-6">
                            <strong data-i18n="contact">Contact:</strong> 
                            <a href="tel:{{ donor.contact_number }}">{{ donor.contact_number }}</a>
                        </div>
                        <div class="col-md-6">
                            <strong data-i18n="email">Email:</strong> 
                            <a href="mailto:{{ donor.email }}">{{ donor.email }}</a>
                        </div>
                        {% if donor.diseases %}
                        <div class="col-12">
                            <strong data-i18n="diseases">Medical Conditions:</strong> 
                            <span class="text-warning">{{ donor.diseases }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Usage Record Form -->
                <form method="POST" action="{{ url_for('create_usage') }}" id="usageForm">
                    <input type="hidden" name="donor_id" value="{{ donor.id }}">
                    
                    <div class="row g-4">
                        <!-- Hospital Information (Read-only) -->
                        <div class="col-12">
                            <h6 class="text-muted mb-3">Hospital Information</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" value="{{ current_user.name }}" readonly>
                                        <label data-i18n="hospital_name">Hospital Name</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" value="{{ current_user.city }}, {{ current_user.state }}" readonly>
                                        <label data-i18n="location">Location</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Usage Date (Auto-filled with current date) -->
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="date" class="form-control" id="usage_date" value="{{ moment().format('YYYY-MM-DD') }}" readonly>
                                <label for="usage_date">Usage Date</label>
                            </div>
                        </div>

                        <!-- Usage Time (Auto-filled with current time) -->
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="time" class="form-control" id="usage_time" readonly>
                                <label for="usage_time">Usage Time</label>
                            </div>
                        </div>

                        <!-- Blood Units (Optional) -->
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="number" class="form-control" id="blood_units" name="blood_units" placeholder="Blood Units" min="1" step="0.1">
                                <label for="blood_units">Blood Units (Optional)</label>
                            </div>
                            <div class="form-text">Enter the number of units used (e.g., 1, 2, 0.5)</div>
                        </div>

                        <!-- Usage Type -->
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select class="form-select" id="usage_type" name="usage_type">
                                    <option value="">Select Usage Type</option>
                                    <option value="Emergency">Emergency</option>
                                    <option value="Surgery">Surgery</option>
                                    <option value="Transfusion">Transfusion</option>
                                    <option value="Treatment">Treatment</option>
                                    <option value="Other">Other</option>
                                </select>
                                <label for="usage_type">Usage Type (Optional)</label>
                            </div>
                        </div>

                        <!-- Usage Notes -->
                        <div class="col-12">
                            <div class="form-floating">
                                <textarea class="form-control" id="notes" name="notes" placeholder="Usage Notes" style="height: 120px"></textarea>
                                <label for="notes" data-i18n="usage_notes">Usage Notes</label>
                            </div>
                            <div class="form-text" data-i18n="optional">Optional: Add any relevant notes about the blood usage, patient condition, or special circumstances.</div>
                        </div>

                        <!-- Confirmation Checkbox -->
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="confirmation" required>
                                <label class="form-check-label" for="confirmation">
                                    <strong>I confirm that this blood usage record is accurate and the blood was used for legitimate medical purposes.</strong>
                                </label>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="col-12">
                            <div class="d-flex gap-3">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-save me-2"></i>
                                    <span data-i18n="save_record">Save Record</span>
                                </button>
                                <a href="{{ url_for('hospital_dashboard') }}" class="btn btn-outline-secondary btn-lg">
                                    <i class="fas fa-times me-2"></i>
                                    <span data-i18n="cancel">Cancel</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirm Blood Usage Record
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Please confirm the following details:</strong></p>
                <ul id="confirmationDetails">
                    <!-- Details will be populated by JavaScript -->
                </ul>
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    This action will create a permanent record in the system. Make sure all information is correct.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span data-i18n="cancel">Cancel</span>
                </button>
                <button type="button" class="btn btn-success" id="confirmSubmit">
                    <i class="fas fa-check me-1"></i>
                    <span data-i18n="confirm">Confirm & Save</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Set current time on page load
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const timeString = now.toTimeString().slice(0, 5);
    document.getElementById('usage_time').value = timeString;
});

// Form submission with confirmation
document.getElementById('usageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Collect form data for confirmation
    const donorName = '{{ donor.name }}';
    const bloodGroup = '{{ donor.blood_group }}';
    const hospitalName = '{{ current_user.name }}';
    const usageDate = document.getElementById('usage_date').value;
    const usageTime = document.getElementById('usage_time').value;
    const bloodUnits = document.getElementById('blood_units').value || 'Not specified';
    const usageType = document.getElementById('usage_type').value || 'Not specified';
    const notes = document.getElementById('notes').value || 'No notes';
    
    // Populate confirmation modal
    const confirmationDetails = document.getElementById('confirmationDetails');
    confirmationDetails.innerHTML = `
        <li><strong>Donor:</strong> ${donorName} (${bloodGroup})</li>
        <li><strong>Hospital:</strong> ${hospitalName}</li>
        <li><strong>Date & Time:</strong> ${usageDate} at ${usageTime}</li>
        <li><strong>Blood Units:</strong> ${bloodUnits}</li>
        <li><strong>Usage Type:</strong> ${usageType}</li>
        <li><strong>Notes:</strong> ${notes}</li>
    `;
    
    // Show confirmation modal
    const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    modal.show();
});

// Confirm and submit
document.getElementById('confirmSubmit').addEventListener('click', function() {
    // Hide modal
    bootstrap.Modal.getInstance(document.getElementById('confirmationModal')).hide();
    
    // Submit form
    document.getElementById('usageForm').submit();
});

// Form validation
document.getElementById('usageForm').addEventListener('submit', function(e) {
    const confirmation = document.getElementById('confirmation').checked;
    
    if (!confirmation) {
        e.preventDefault();
        alert('Please confirm that the blood usage record is accurate.');
        return false;
    }
});

// Auto-save draft functionality
let draftTimer;
function saveDraft() {
    const formData = {
        donor_id: '{{ donor.id }}',
        notes: document.getElementById('notes').value,
        blood_units: document.getElementById('blood_units').value,
        usage_type: document.getElementById('usage_type').value
    };
    
    localStorage.setItem('bloodlink_usage_draft', JSON.stringify(formData));
}

// Load draft on page load
document.addEventListener('DOMContentLoaded', function() {
    const draft = localStorage.getItem('bloodlink_usage_draft');
    if (draft) {
        const data = JSON.parse(draft);
        if (data.donor_id === '{{ donor.id }}') {
            document.getElementById('notes').value = data.notes || '';
            document.getElementById('blood_units').value = data.blood_units || '';
            document.getElementById('usage_type').value = data.usage_type || '';
            
            // Show draft notification
            showToast('Draft restored from previous session', 'info');
        }
    }
});

// Save draft on input
document.querySelectorAll('#notes, #blood_units, #usage_type').forEach(input => {
    input.addEventListener('input', function() {
        clearTimeout(draftTimer);
        draftTimer = setTimeout(saveDraft, 1000);
    });
});

// Clear draft on successful submission
document.getElementById('usageForm').addEventListener('submit', function() {
    localStorage.removeItem('bloodlink_usage_draft');
});

// Warn before leaving with unsaved changes
let formChanged = false;
document.querySelectorAll('#notes, #blood_units, #usage_type').forEach(input => {
    input.addEventListener('input', function() {
        formChanged = true;
    });
});

window.addEventListener('beforeunload', function(e) {
    if (formChanged) {
        e.preventDefault();
        e.returnValue = '';
    }
});
</script>
{% endblock %}